<!DOCTYPE html>
<html>
<!-- include three.js -->
<script src='vendor/three.js/build/three.js'></script>
<script src='vendor/three.js/examples/js/libs/stats.min.js'></script>

<!-- include js-aruco -->
<script src='../vendor/js-aruco/svd.js'></script>
<script src='../vendor/js-aruco/posit1-patched.js'></script>
<script src='../vendor/js-aruco/cv.js'></script>
<script src='../vendor/js-aruco/aruco.js'></script>

<!-- include some extensions -->
<script src='../threex.webcamgrabbing.js'></script>
<script src='../threex.imagegrabbing.js'></script>
<script src='../threex.videograbbing.js'></script>
<script src='../threex.jsarucomarker.js'></script>

<head>
  <title>
    MappacheCo.
  </title>
  <style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
	</style>
</head>

<body style='margin: 0px; overflow: hidden;'>
  <h1>Mappache co. Testing Environment</h1>
  <div id='info' style='position: absolute; top: 0px; width: 100%;font-family:arial; font-weight: bolder; padding-top: 5px; text-align:center;'>
    No te pide acceso a la camara? Haz click aca:
  	<a class='webcam' href='javascript:void();'>webcam</a>
  </div>
  <script>


//////////////////////////////////////////////////////////////////////////////////
//		Handle ui button //// que te acceda a la camara cuando cliqueas en 'webcam'
//////////////////////////////////////////////////////////////////////////////////
document.querySelector('#info .webcam').addEventListener('click', function(event){
  location.hash	= '#webcam'
  location.reload()
})

//////////////////////////////////////////////////////////////////////////////////
//		Init - esto es tal cual la documentacion basica de THREE.
//////////////////////////////////////////////////////////////////////////////////

var scene = new THREE.Scene()
var camera	= new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.01, 1000);
camera.position.z = 5;
// init renderer
var renderer	= new THREE.WebGLRenderer({
  antialias	: true,
  alpha		: true,
});
renderer.setSize( window.innerWidth, window.innerHeight );
document.body.appendChild( renderer.domElement );

// array of functions for the rendering loop
var onRenderFcts = [];

// init scene and camera

/*/////////////////////////// agrega un cubo
var geometry = new THREE.BoxGeometry( 1, 1, 1 );
			var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
			var cube = new THREE.Mesh( geometry, material );
			scene.add( cube ); */

      // instantiate a loader
      var loader = new THREE.OBJLoader();

      // load a resource
      loader.load(
      	// resource URL
      	'images/mamappache.obj',
      	// Function when resource is loaded
      	function ( object ) {
      		scene.add( object );
      	}
      );
/*///////////////////// renderiza todo.
var render = function () {
				requestAnimationFrame( render );

				//cube.rotation.x += 0.1;
				cube.rotation.y += 0.06;

				renderer.render(scene, camera);
			};
render();

*/ //esto de arriba renderiza sin la parte de AR

//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////

	// handle window resize
	window.addEventListener('resize', function(){
		renderer.setSize( window.innerWidth, window.innerHeight )
		camera.aspect	= window.innerWidth / window.innerHeight
		camera.updateProjectionMatrix()
	}, false)

	// set the scene as visible
	scene.visible	= false

	// render the scene
	onRenderFcts.push(function(){
		renderer.render( scene, camera );
	})

	// run the rendering loop
	var previousTime = performance.now()
	requestAnimationFrame(function animate(now){

		requestAnimationFrame( animate );

		onRenderFcts.forEach(function(onRenderFct){
			onRenderFct(now, now - previousTime)
		})

		previousTime	= now
	})


  //////////////////////////////////////////////////////////////////////////////////
  	//		Do the Augmented Reality Upgrade
  	//////////////////////////////////////////////////////////////////////////////////


  	// init the marker recognition
  	var jsArucoMarker	= new THREEx.JsArucoMarker()

  	// init the image source grabbing
  	if( false ){
  		var videoGrabbing = new THREEx.VideoGrabbing()
  		jsArucoMarker.videoScaleDown = 10
  	}else if( true ){
  		var videoGrabbing = new THREEx.WebcamGrabbing()
  		jsArucoMarker.videoScaleDown = 2
  	}else if( true ){
  		var videoGrabbing = new THREEx.ImageGrabbing()
  		jsArucoMarker.videoScaleDown = 10
  	}else console.assert(false)

  	// attach the videoGrabbing.domElement to the body
          document.body.appendChild(videoGrabbing.domElement)

  	// process the image source with the marker recognition
  	onRenderFcts.push(function(){
  		var domElement	= videoGrabbing.domElement
  		var markers	= jsArucoMarker.detectMarkers(domElement)
  		var object3d	= scene

  		object3d.visible = false

  		// see if this.markerId has been found
  		markers.forEach(function(marker){
  			// if( marker.id !== 265 )	return

  			jsArucoMarker.markerToObject3D(marker, object3d)

  			object3d.visible = true
  		})
  	})
  </script>
</body>
</html>
