<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<!-- include three.js -->
<script src='vendor/three.js/build/three.js'></script>
<script src='vendor/three.js/examples/js/libs/stats.min.js'></script>
<!-- en la linea 188 cambias que mostrar -->
<!-- include js-aruco -->
<script src='../vendor/js-aruco/svd.js'></script>
<script src='../vendor/js-aruco/posit1-patched.js'></script>
<script src='../vendor/js-aruco/cv.js'></script>
<script src='../vendor/js-aruco/aruco.js'></script>

<!-- include some extensions -->
<script src='../threex.webcamgrabbing.js'></script>
<script src='../threex.imagegrabbing.js'></script>
<script src='../threex.videograbbing.js'></script>
<script src='../threex.jsarucomarker.js'></script>
<script src='../../threex.videotexture-master/threex.videotexture.js'></script>


<div id='info' style='position: absolute; top: 0px; width: 100%;font-family:arial; font-weight: bolder; padding-top: 5px; text-align:center;'>

	Estamos usando este <a target='blank' href='http://mappache.github.io/testing/marker/built-single-marker.html'>Codigo QR</a>

	<br/>
	No te pide acceso a la camara? Proba pedirle:
	<a class='webcam' href='javascript:void();'>webcam</a>
	<!--<a class='image'  href='javascript:void();'></a>
	<a class='video'  href='javascript:void();'></a> -->
  <br/>
  <button onclick='onVideoPlayButtonClick()'>play</button>
  <button onclick='onVideoPauseButtonClick()'>pause</button>
</div>

<body style='margin: 0px; overflow: hidden;'>



<div id='performanceEnabler' style='position: absolute; top: 0px; right: 0px; text-align: right;background-color:rgba(255,255,255,0.5);padding-left: 10px; padding-bottom: 10px;border-width: 1px;
  border-style: solid;'>
	<div style='text-align: center;'>OPTIONS</div>
	<hr/>
	<label id='detectMarkersEnabled' title='to enable/disable marker detection in video'>
		detectMarkers	<input type="checkbox">
	</label>
	<br/>
	<label id='markerToObject3DEnabled' title='to enable/disable marker to object3d conversion'>
		markerToObject3D <input type="checkbox">
	</label>
	<br/>
	<label id='webglRenderEnabled' title='to enable/disable webgl rendering'>
		webglRender	<input type="checkbox">
	</label>
	<br/>
	<label id='markerDebugEnabled' title='to enable/disable marker debug'>
		marker debug	<input type="checkbox">
	</label>
	<br/>
</div>

<script>
	//////////////////////////////////////////////////////////////////////////////////
	//		Test if the browser support WebGL and getUserMedia
	//////////////////////////////////////////////////////////////////////////////////
	;(function(){
		// TODO backport those 2 in Detector.js
		var hasGetUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia) ? true : false
		var hasMediaStreamTrackSources = MediaStreamTrack.getSources ? true : false
		var hasWebGL = ( function () { try { var canvas = document.createElement( 'canvas' ); return !! ( window.WebGLRenderingContext && ( canvas.getContext( 'webgl' ) || canvas.getContext( 'experimental-webgl' ) ) ); } catch ( e ) { return false; } } )()

		if( hasWebGL === false ){
			alert('your browser doesn\'t support navigator.getUserMedia()')
		}
		if( hasMediaStreamTrackSources === false ){
			alert('your browser doesn\'t support MediaStreamTrack.getSources()')
		}
		if( hasGetUserMedia === false ){
			alert('your browser doesn\'t support navigator.getUserMedia()')
		}
	})()

	//////////////////////////////////////////////////////////////////////////////////
	//		enabled/disable various parts
	//////////////////////////////////////////////////////////////////////////////////

	var detectMarkersEnabled	= true
	var markerToObject3DEnabled	= true
	var webglRenderEnabled		= true

	document.querySelector('#detectMarkersEnabled input').checked	= detectMarkersEnabled
	document.querySelector('#detectMarkersEnabled input').addEventListener('change', function(){
		detectMarkersEnabled = document.querySelector('#detectMarkersEnabled input').checked
	})

	document.querySelector('#markerToObject3DEnabled input').checked= markerToObject3DEnabled
	document.querySelector('#markerToObject3DEnabled input').addEventListener('change', function(){
		markerToObject3DEnabled = document.querySelector('#markerToObject3DEnabled input').checked
	})

	document.querySelector('#webglRenderEnabled input').checked	= webglRenderEnabled
	document.querySelector('#webglRenderEnabled input').addEventListener('change', function(){
		webglRenderEnabled = document.querySelector('#webglRenderEnabled input').checked
		// clear the webgl canvas - thus the last webgl rendering disapears
		renderer.clear()
	})

	document.querySelector('#markerDebugEnabled input').checked	= false
	document.querySelector('#markerDebugEnabled input').addEventListener('change', function(){
		jsArucoMarker.debugEnabled = document.querySelector('#markerDebugEnabled input').checked
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		init Stats for detectMarkers
	//////////////////////////////////////////////////////////////////////////////////
	var detectMarkersStats = new Stats();
	detectMarkersStats.setMode( 1 );
	document.body.appendChild( detectMarkersStats.domElement );
        detectMarkersStats.domElement.style.position = 'absolute'
	detectMarkersStats.domElement.style.bottom = '0px'
	detectMarkersStats.domElement.style.right = '0px'

	var renderStats = new Stats();
	renderStats.setMode( 0 );
	document.body.appendChild( renderStats.domElement );
        renderStats.domElement.style.position = 'absolute'
	renderStats.domElement.style.bottom = '0px'
	renderStats.domElement.style.left = '0px'

	//////////////////////////////////////////////////////////////////////////////////
	//		Handle ui button
	//////////////////////////////////////////////////////////////////////////////////
	document.querySelector('#info .webcam').addEventListener('click', function(event){
		location.hash	= '#webcam'
		location.reload()
	})

	/*document.querySelector('#info .image').addEventListener('click', function(event){
		location.hash	= '#image'
		location.reload()
	})

	document.querySelector('#info .video').addEventListener('click', function(event){
		location.hash	= '#video'
		location.reload()
	})*/

	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////

	// init renderer
	var renderer	= new THREE.WebGLRenderer({
		antialias	: true,
		alpha		: true,
	});
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	// array of functions for the rendering loop
	var onRenderFcts = [];
  var updateFcts	= [];
	// init scene and camera
	var scene = new THREE.Scene()
	var camera	= new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.01, 1000);
	camera.position.z = 2;

	//////////////////////////////////////////////////////////////////////////////////
	//		create a markerObject3D
	//////////////////////////////////////////////////////////////////////////////////
	var markerObject3D = new THREE.Object3D()
	scene.add(markerObject3D)

	//////////////////////////////////////////////////////////////////////////////////
	//		add an object in the markerObject3D
	//////////////////////////////////////////////////////////////////////////////////

  // find out which file formats i can read
  var canPlayMp4	= document.createElement('video').canPlayType('video/mp4') !== '' ? true : false
  var canPlayOgg	= document.createElement('video').canPlayType('video/ogg') !== '' ? true : false
  if( canPlayMp4 ){
    var url	= 'videos/sintel.mp4'
  }else if( canPlayOgg ){
    var url	= 'videos/sintel.ogv'
  }else	alert('cant play mp4 or ogv')

  // create the videoTexture
  var videoTexture= new THREEx.VideoTexture(url)
  var video	= videoTexture.video
  updateFcts.push(function(delta, now){
    videoTexture.update(delta, now)
  })

  // use the texture in a THREE.Mesh
  var geometry	= new THREE.CubeGeometry(1,1,1);
  var material	= new THREE.MeshBasicMaterial({
    map	: videoTexture.texture
  });
  var mesh	= new THREE.Mesh( geometry, material );
  markerObject3D.add( mesh );
  updateFcts.push(function(delta, now){
    mesh.rotation.x += 1 * delta;
    mesh.rotation.y += 2 * delta;
  })

  function onVideoPlayButtonClick(){
    video.play()
  }
  function onVideoPauseButtonClick(){
    video.pause()
  }
	//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////

  // init Stats
  var stats	= new Stats();
  document.body.appendChild( stats.domElement );
  stats.domElement.style.position = 'absolute';
  stats.domElement.style.left	= '0px';
  stats.domElement.style.bottom	= '0px';
  updateFcts.push(function(){
    stats.update()
  })


  updateFcts.push(function(){
    renderer.render( scene, camera );
  })

  //////////////////////////////////////////////////////////////////////////////////
  //		loop runner							//
  //////////////////////////////////////////////////////////////////////////////////
  var lastTimeMsec= null
  requestAnimationFrame(function animate(nowMsec){
    // keep looping
    requestAnimationFrame( animate );
    // measure time
    lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
    var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
    lastTimeMsec	= nowMsec
    // call each update function
    updateFcts.forEach(function(updateFn){
      updateFn(deltaMsec/1000, nowMsec/1000)
    })
  })

	//////////////////////////////////////////////////////////////////////////////////
	//		Do the Augmented Reality part
	//////////////////////////////////////////////////////////////////////////////////


	// init the marker recognition
	var jsArucoMarker	= new THREEx.JsArucoMarker()

	// if no specific image source is specified, take the webcam by default
	if( location.hash === '' )	location.hash = '#webcam'

	// init the image source grabbing
	if( location.hash === '#video' ){
		var videoGrabbing = new THREEx.VideoGrabbing()
		jsArucoMarker.videoScaleDown = 2
	}else if( location.hash === '#webcam' ){
		var videoGrabbing = new THREEx.WebcamGrabbing()
		jsArucoMarker.videoScaleDown = 2
	}else if( location.hash === '#image' ){
		var videoGrabbing = new THREEx.ImageGrabbing()
		jsArucoMarker.videoScaleDown = 10
	}else console.assert(false)

	// attach the videoGrabbing.domElement to the body
        document.body.appendChild(videoGrabbing.domElement)

	//////////////////////////////////////////////////////////////////////////////////
	//		Process video source to find markers
	//////////////////////////////////////////////////////////////////////////////////
	// set the markerObject3D as visible
	markerObject3D.visible	= false
	// process the image source with the marker recognition
	onRenderFcts.push(function(){
		if( detectMarkersEnabled === false )	return

		var domElement	= videoGrabbing.domElement
		detectMarkersStats.begin();
		var markers	= jsArucoMarker.detectMarkers(domElement)
		detectMarkersStats.end();

		if( markerToObject3DEnabled === false )	return
		markerObject3D.visible = false

		// see if this.markerId has been found
		markers.forEach(function(marker){
			// if( marker.id !== 265 )	return

			jsArucoMarker.markerToObject3D(marker, markerObject3D)

			markerObject3D.visible = true
		})
	})
</script></body>
