<!DOCTYPE html>
<html>
<!-- include three.js -->
<script src='vendor/three.js/build/three.js'></script>
<script src='vendor/three.js/examples/js/libs/stats.min.js'></script>

<!-- include js-aruco -->
<script src='../vendor/js-aruco/svd.js'></script>
<script src='../vendor/js-aruco/posit1-patched.js'></script>
<script src='../vendor/js-aruco/cv.js'></script>
<script src='../vendor/js-aruco/aruco.js'></script>

<!-- include some extensions -->
<script src='../threex.webcamgrabbing.js'></script>
<script src='../threex.imagegrabbing.js'></script>
<script src='../threex.videograbbing.js'></script>
<script src='../threex.jsarucomarker.js'></script>

<head>
  <title>
    MappacheCo.
  </title>
  <style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
	</style>
</head>

<body style='margin: 0px; overflow: hidden;'>
  <h1>Mappache co. Testing Environment</h1>
  <div id='info' style='position: absolute; top: 0px; width: 100%;font-family:arial; font-weight: bolder; padding-top: 5px; text-align:center;'>
    No te pide acceso a la camara? Haz click aca:
  	<a class='webcam' href='javascript:void(0);'>webcam</a>;
      Estamos usando este <a target='blank' href='http://mappache.github.io/testing/marker/built-single-marker.html'>Codigo QR</a>
  </div>
  <script>

    //////////////////////////////////////////////////////////////////////////////////
    //		init Stats for detectMarkers
    //////////////////////////////////////////////////////////////////////////////////
    var detectMarkersStats = new Stats();
    detectMarkersStats.setMode( 1 );
    document.body.appendChild( detectMarkersStats.domElement );
    detectMarkersStats.domElement.style.position = 'absolute'
    detectMarkersStats.domElement.style.bottom = '0px'
    detectMarkersStats.domElement.style.right = '0px'

    var renderStats = new Stats();
    renderStats.setMode( 0 );
    document.body.appendChild( renderStats.domElement );
    renderStats.domElement.style.position = 'absolute'
    renderStats.domElement.style.bottom = '0px'
    renderStats.domElement.style.left = '0px'

//////////////////////////////////////////////////////////////////////////////////
//		Handle ui button //// que te acceda a la camara cuando cliqueas en 'webcam'
//////////////////////////////////////////////////////////////////////////////////
document.querySelector('#info .webcam').addEventListener('click', function(event){
  location.hash	= '#webcam';
  location.reload();
});

//////////////////////////////////////////////////////////////////////////////////
//		Init
//////////////////////////////////////////////////////////////////////////////////

// init renderer
var renderer	= new THREE.WebGLRenderer({
  antialias	: true,
  alpha		: true,
});
renderer.setSize( window.innerWidth, window.innerHeight );
document.body.appendChild( renderer.domElement );

// array of functions for the rendering loop
var onRenderFcts = [];

// init scene and camera
var scene = new THREE.Scene()
var camera	= new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.01, 1000);
camera.position.z = 2;

//////////////////////////////////////////////////////////////////////////////////
//		create a markerObject3D
//////////////////////////////////////////////////////////////////////////////////
var markerObject3D = new THREE.Object3D()
scene.add(markerObject3D)


// Create a light, set its position, and add it to the scene.
var light = new THREE.PointLight(0xffffff);
light.position.set(0,0,100);
scene.add(light);

//////////////////////////////////////////////////////////////////////////////////
//		add an object in the markerObject3D
//////////////////////////////////////////////////////////////////////////////////

// add some debug display
;(function(){
  var geometry = new THREE.PlaneGeometry(1,1,10,10)
  var material = new THREE.MeshBasicMaterial( {
    wireframe : true
  })
  var mesh = new THREE.Mesh(geometry, material);
  //mesh.position.set(scene.position);
  //markerObject3D.add( mesh );

  var axis = new THREE.AxisHelper(5)
  //mesh.rotation.z = Math.PI /2;
  //mesh.position.set(scene.position);
  markerObject3D.add( axis );
})()

// add a awesome logo to the scene
function Anim(){

  counter = 3;
  onRenderFcts.push(function(now, delta){
    counter += 0.1;
    if (counter<6) {
      mappache.scale.x = mappache.scale.y = mappache.scale.z = counter;
      markerObject3D.add( mappache );

    };
    if(counter>6){
      counter = 3
    }
  })
}

;(function(){
  var material = new THREE.SpriteMaterial({
    map: THREE.ImageUtils.loadTexture( 'images/mappache2.png' ),
  });
  var geometry = new THREE.BoxGeometry(1,1,1)
  var object3d = new THREE.Sprite(material);
  object3d.scale.set( 2, 2, 1 );
  markerObject3D.add(object3d);

  // Load in the mesh and add it to the scene.
  var loader = new THREE.JSONLoader();
  loader.load( "images/mappache.json", function(geometry){
    var material = new THREE.MeshLambertMaterial({color: 0x55B663});
            //new THREE.MeshPhongMaterial({map: THREE.ImageUtils.loadTexture( 'images/mappache2.jpg' )});
    mappache = new THREE.Mesh(geometry,material);
    mappache.rotation.y =  Math.PI /2;
    //mano.rotation.x = Math.PI /2;

    //mano.position.y = -1.4;
    //mano.position.x = -0.6;
    //mano.position.z = -0.1;
    //var pivot = new THREE.Object3D();
    //pivot.translateX(0);
    //pivot.translateY(1.4);
    //pivot.translateZ(0);
    //pivot.position.x = 0.6;
    //pivot.position.y = 1.4;
    //pivot.position.z = 0.1;
    //pivot.add(mano);
    //mano.position.x = -0.6;
    //mano.position.y = -1.4;
    //mano.position.z = -0.1;

    //pivot.rotation.x = Math.PI /2;
    //pivot.rotateZ(Math.PI /2);
    //pivot.translateX(-0.6);
    //pivot.translateY(-1.4);
    //pivot.translateZ(0);



    //mano.position.x = mano.position.y = mano.position.z = 0;
    //mano.position.x = -0.6;
    //mano.position.x = -1;
    //mano.position.z = -10;
    //mano.scale.x = mano.scale.y = mano.scale.z = 6;
    //mesh.position.set(scene.position);
    //mesh.rotation.z = Math.PI /2;
    markerObject3D.add(mappache);
  });


})()

//////////////////////////////////////////////////////////////////////////////////
//		render the whole thing on the page
//////////////////////////////////////////////////////////////////////////////////

// handle window resize
window.addEventListener('resize', function(){
  renderer.setSize( window.innerWidth, window.innerHeight )
  camera.aspect	= window.innerWidth / window.innerHeight
  camera.updateProjectionMatrix()
}, false)


// render the scene
onRenderFcts.push(function(){
  renderStats.begin();
  if( webglRenderEnabled === true ){
    renderer.render( scene, camera );
  }
  renderStats.end();
})

// run the rendering loop
var previousTime = performance.now()
requestAnimationFrame(function animate(now){

  requestAnimationFrame( animate );

  onRenderFcts.forEach(function(onRenderFct){
    onRenderFct(now, now - previousTime)
  })

  previousTime	= now
})



//////////////////////////////////////////////////////////////////////////////////
//		Do the Augmented Reality part
//////////////////////////////////////////////////////////////////////////////////


// init the marker recognition
var jsArucoMarker	= new THREEx.JsArucoMarker()

// if no specific image source is specified, take the webcam by default
if( location.hash === '' )	location.hash = '#webcam'

// init the image source grabbing
if( location.hash === '#video' ){
  var videoGrabbing = new THREEx.VideoGrabbing()
  jsArucoMarker.videoScaleDown = 2
}else if( location.hash === '#webcam' ){
  var videoGrabbing = new THREEx.WebcamGrabbing()
  jsArucoMarker.videoScaleDown = 2
}else if( location.hash === '#image' ){
  var videoGrabbing = new THREEx.ImageGrabbing()
  jsArucoMarker.videoScaleDown = 10
}else console.assert(false)

// attach the videoGrabbing.domElement to the body
document.body.appendChild(videoGrabbing.domElement)

//////////////////////////////////////////////////////////////////////////////////
//		Process video source to find markers
//////////////////////////////////////////////////////////////////////////////////
// set the markerObject3D as visible
markerObject3D.visible	= false
// process the image source with the marker recognition
onRenderFcts.push(function(){
  if( detectMarkersEnabled === false )	return

  var domElement	= videoGrabbing.domElement
  detectMarkersStats.begin();
  var markers	= jsArucoMarker.detectMarkers(domElement)
  detectMarkersStats.end();

  if( markerToObject3DEnabled === false )	return
  markerObject3D.visible = false

  // see if this.markerId has been found
  markers.forEach(function(marker){
    // if( marker.id !== 265 )	return

    jsArucoMarker.markerToObject3D(marker, markerObject3D)

    markerObject3D.visible = true
    //Aca llamamos a las funciones para loopear
    Anim() //modifique esto - max
  })
})
  </script></body>

</html>
